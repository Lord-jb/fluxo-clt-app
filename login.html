<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | Fluxo CLT</title>
    <!-- **A CORREÇÃO ESTÁ AQUI**: Adicionado o script do Tailwind CSS para corrigir o design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos CSS diretamente no HTML para garantir que são aplicados */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; color: #FFFFFF; background-color: #222222; }
        .bg-carbon-light { background-color: #333333; }
        .text-accent-gold { color: #FFD700; }
        .form-input { width: 100%; margin-top: 0.25rem; padding: 0.75rem 1rem; background-color: #444444; border: 1px solid #555555; color: #FFFFFF; border-radius: 0.5rem; transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .form-input:focus { outline: none; border-color: #FFD700; box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.5); }
        .button-primary { width: 100%; padding: 0.75rem 1rem; font-weight: 600; color: #1a1a1a; background-color: #FFD700; border-radius: 0.5rem; transition: background-color 0.2s ease-in-out; border: none; cursor: pointer; }
        .button-primary:hover { background-color: #FFC700; }
        .toast { position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; z-index: 9999; opacity: 0; transform: translateY(-20px); transition: opacity 0.3s ease, transform 0.3s ease; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md p-8 space-y-8 bg-carbon-light rounded-xl shadow-lg">
        <div>
            <h2 class="text-3xl font-bold text-center text-white">Fluxo <span class="text-accent-gold">CLT</span></h2>
            <p class="mt-2 text-center text-gray-400">Sua vida financeira, simplificada.</p>
        </div>

        <form id="login-form" class="mt-8 space-y-6">
            <div class="space-y-4 rounded-md shadow-sm">
                <div><input id="login-email" type="email" autocomplete="email" required class="form-input" placeholder="Seu e-mail"></div>
                <div><input id="login-password" type="password" autocomplete="current-password" required class="form-input" placeholder="Sua senha"></div>
            </div>
            <div class="flex items-center justify-end text-sm">
                <a href="#" id="forgot-password-link" class="font-medium text-accent-gold hover:text-yellow-300">Esqueceu a senha?</a>
            </div>
            <div><button type="submit" class="button-primary">Entrar</button></div>
        </form>

        <form id="register-form" class="hidden mt-8 space-y-6">
             <div class="space-y-4 rounded-md shadow-sm">
                <div><input id="register-email" type="email" autocomplete="email" required class="form-input" placeholder="Seu melhor e-mail"></div>
                <div><input id="register-password" type="password" autocomplete="new-password" required class="form-input" placeholder="Crie uma senha forte"></div>
            </div>
            <div><button type="submit" class="button-primary">Criar Conta</button></div>
        </form>

        <div class="text-sm text-center">
            <a href="#" id="toggle-form-link" class="font-medium text-accent-gold hover:text-yellow-300">Não tem uma conta? Crie uma agora!</a>
        </div>
    </div>
    <div id="toast-container"></div>

    <!-- TODO O JAVASCRIPT ESTÁ AQUI DENTRO -->
    <script type="module">
        // Importações diretas do Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, Timestamp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

        // 1. INICIALIZAÇÃO DO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCZPZY8AJAJxPJ11xGj2tOWIGHdjh0_W3w",
            authDomain: "minhasfinancasclt.firebaseapp.com",
            projectId: "minhasfinancasclt",
            storageBucket: "minhasfinancasclt.firebasestorage.app",
            messagingSenderId: "551624927055",
            appId: "1:551624927055:web:c92968f4d02551df6ec73a",
            measurementId: "G-09Q73V2B1B"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 2. UTILITÁRIOS
        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container') || document.body;
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };
        const translateAuthError = (error) => {
            switch (error.code) {
                case 'auth/user-not-found': return 'Nenhuma conta encontrada com este e-mail.';
                case 'auth/wrong-password': return 'Senha incorreta. Por favor, tente novamente.';
                case 'auth/email-already-in-use': return 'Este e-mail já está a ser utilizado por outra conta.';
                case 'auth/weak-password': return 'A sua senha é muito fraca. Use pelo menos 6 caracteres.';
                case 'auth/invalid-email': return 'O e-mail fornecido não é válido.';
                case 'auth/network-request-failed': return 'Erro de rede. Verifique a sua conexão com a internet.';
                default: return 'Ocorreu um erro inesperado. Por favor, tente mais tarde.';
            }
        };

        // 3. LÓGICA DE AUTENTICAÇÃO
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const toggleLink = document.getElementById('toggle-form-link');
        const forgotPasswordLink = document.getElementById('forgot-password-link');

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists() && userDocSnap.data().onboardingComplete) {
                    window.location.href = 'index.html'; // Usar .href para garantir o carregamento
                } else {
                    window.location.href = 'onboarding.html';
                }
            }
        });

        toggleLink.addEventListener('click', e => {
            e.preventDefault();
            loginForm.classList.toggle('hidden');
            registerForm.classList.toggle('hidden');
            toggleLink.textContent = registerForm.classList.contains('hidden')
                ? 'Não tem uma conta? Crie uma agora!'
                : 'Já tem uma conta? Faça login!';
        });

        registerForm.addEventListener('submit', async e => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "users", cred.user.uid), {
                    email: cred.user.email,
                    createdAt: Timestamp.now(),
                    onboardingComplete: false,
                    profile: {}
                });
            } catch (error) {
                showToast(translateAuthError(error), 'error');
            }
        });

        loginForm.addEventListener('submit', async e => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showToast(translateAuthError(error), 'error');
            }
        });

        forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            const email = prompt("Por favor, insira o seu e-mail para receber o link de redefinição:");
            if (email) {
                sendPasswordResetEmail(auth, email)
                    .then(() => showToast('Link de redefinição enviado! Verifique o seu e-mail.', 'success'))
                    .catch((error) => showToast(translateAuthError(error), 'error'));
            }
        });
    </script>
</body>
</html>
