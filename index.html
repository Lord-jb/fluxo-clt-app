<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluxo CLT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; color: #FFFFFF; background-color: #1a1a1a; }
        .bg-carbon { background-color: #222222; }
        .bg-carbon-light { background-color: #333333; }
        .bg-accent-gold { background-color: #FFD700; color: #1a1a1a; }
        .bg-accent-gold:hover { background-color: #FFC700; }
        .text-accent-gold { color: #FFD700; }
        .form-input { width: 100%; margin-top: 0.25rem; padding: 0.75rem 1rem; background-color: #444444; border: 1px solid #555555; color: #FFFFFF; border-radius: 0.5rem; transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .form-input:focus { outline: none; border-color: #FFD700; box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.5); }
        .button-primary { width: 100%; padding: 0.75rem 1rem; font-weight: 600; color: #1a1a1a; background-color: #FFD700; border-radius: 0.5rem; transition: background-color 0.2s ease-in-out; border: none; cursor: pointer; }
        .button-primary:hover { background-color: #FFC700; }
        .nav-item { transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; }
        .nav-item.active { background-color: #FFD700; color: #1a1a1a; font-weight: 600; }
        .nav-item.active svg { color: #1a1a1a; }
        .toast { position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; z-index: 9999; opacity: 0; transform: translateY(-20px); transition: opacity 0.3s ease, transform 0.3s ease; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
    </style>
</head>
<body>

    <!-- Container da Tela de Login -->
    <div id="login-view" class="hidden items-center justify-center min-h-screen w-full">
        <div class="w-full max-w-md p-8 space-y-8 bg-carbon-light rounded-xl shadow-lg">
            <div>
                <h2 class="text-3xl font-bold text-center text-white">Fluxo <span class="text-accent-gold">CLT</span></h2>
                <p class="mt-2 text-center text-gray-400">Sua vida financeira, simplificada.</p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div class="space-y-4"><input id="login-email" type="email" required class="form-input" placeholder="Seu e-mail"><input id="login-password" type="password" required class="form-input" placeholder="Sua senha"></div>
                <div class="flex items-center justify-end text-sm"><a href="#" id="forgot-password-link" class="font-medium text-accent-gold hover:text-yellow-300">Esqueceu a senha?</a></div>
                <div><button type="submit" class="button-primary">Entrar</button></div>
            </form>
            <form id="register-form" class="hidden mt-8 space-y-6">
                <div class="space-y-4"><input id="register-email" type="email" required class="form-input" placeholder="Seu melhor e-mail"><input id="register-password" type="password" required class="form-input" placeholder="Crie uma senha forte"></div>
                <div><button type="submit" class="button-primary">Criar Conta</button></div>
            </form>
            <div class="text-sm text-center"><a href="#" id="toggle-form-link" class="font-medium text-accent-gold hover:text-yellow-300">Não tem uma conta? Crie uma agora!</a></div>
        </div>
    </div>

    <!-- Container da Tela de Onboarding -->
    <div id="onboarding-view" class="hidden items-center justify-center min-h-screen w-full">
        <div class="w-full max-w-2xl p-8 space-y-6 bg-carbon-light rounded-xl shadow-lg">
            <div>
                <h2 class="text-3xl font-bold text-center text-white">Bem-vindo(a) ao <span class="text-accent-gold">Fluxo CLT</span>!</h2>
                <p class="mt-2 text-center text-gray-400">Vamos configurar o seu perfil financeiro inicial.</p>
            </div>
            <form id="onboarding-form" class="space-y-6">
                <div class="border-b border-gray-600 pb-4">
                    <h3 class="text-xl font-semibold text-white">Sua Renda Principal</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div>
                            <label for="salario-bruto" class="block text-sm font-medium text-gray-300">Salário Bruto Mensal</label>
                            <input type="text" id="salario-bruto" class="form-input" required placeholder="R$ 0,00">
                        </div>
                        <div>
                            <label for="dia-recebimento" class="block text-sm font-medium text-gray-300">Data de Recebimento</label>
                            <select id="dia-recebimento" class="form-input">
                                <option value="5-util">5º Dia Útil</option>
                                <option value="fixo">Dia Fixo do Mês</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="pt-6"><button type="submit" class="button-primary">Concluir e Ir para o Dashboard</button></div>
            </form>
        </div>
    </div>

    <!-- Container Principal da Aplicação -->
    <div id="app-view" class="hidden h-screen w-full">
        <!-- O conteúdo do dashboard será inserido aqui -->
    </div>

    <div id="toast-container"></div>

    <!-- TODO O JAVASCRIPT DA APLICAÇÃO ESTÁ AQUI DENTRO -->
    <script type="module">
        // 1. IMPORTAÇÕES E INICIALIZAÇÃO DO FIREBASE
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, signOut } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, updateDoc, Timestamp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCZPZY8AJAJxPJ11xGj2tOWIGHdjh0_W3w",
            authDomain: "minhasfinancasclt.firebaseapp.com",
            projectId: "minhasfinancasclt",
            storageBucket: "minhasfinancasclt.firebasestorage.app",
            messagingSenderId: "551624927055",
            appId: "1:551624927055:web:c92968f4d02551df6ec73a"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 2. UTILITÁRIOS
        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };
        const translateAuthError = (error) => { /* ... (código do translateAuthError) ... */ };
        const parseCurrency = (value) => Number(String(value).replace(/[^0-9,-]+/g, "").replace(",", ".")) || 0;

        // 3. LÓGICA DE CONTROLO DE VISUALIZAÇÃO
        const loginView = document.getElementById('login-view');
        const onboardingView = document.getElementById('onboarding-view');
        const appView = document.getElementById('app-view');

        function showView(view) {
            loginView.style.display = 'none';
            onboardingView.style.display = 'none';
            appView.style.display = 'none';
            view.style.display = 'flex';
        }

        // 4. PONTO DE ENTRADA E ORQUESTRADOR PRINCIPAL
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists() && userDocSnap.data().onboardingComplete) {
                    showView(appView);
                    renderMainApp(user, userDocSnap.data());
                } else {
                    showView(onboardingView);
                    initializeOnboardingPage(user);
                }
            } else {
                showView(loginView);
                initializeLoginPage();
            }
        });

        // 5. LÓGICA DA PÁGINA DE LOGIN
        function initializeLoginPage() {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const toggleLink = document.getElementById('toggle-form-link');
            const forgotPasswordLink = document.getElementById('forgot-password-link');

            toggleLink.addEventListener('click', e => { /* ... (código do toggleLink) ... */ });
            
            registerForm.onsubmit = async (e) => {
                e.preventDefault();
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                try {
                    const cred = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(doc(db, "users", cred.user.uid), {
                        email: cred.user.email,
                        createdAt: Timestamp.now(),
                        onboardingComplete: false,
                        profile: {}
                    });
                    // onAuthStateChanged irá tratar do redirecionamento
                } catch (error) { showToast(translateAuthError(error), 'error'); }
            };

            loginForm.onsubmit = async (e) => { /* ... (código do loginForm.onsubmit) ... */ };
            forgotPasswordLink.onclick = (e) => { /* ... (código do forgotPasswordLink.onclick) ... */ };
        }
        
        // 6. LÓGICA DA PÁGINA DE ONBOARDING
        function initializeOnboardingPage(user) {
            const onboardingForm = document.getElementById('onboarding-form');
            onboardingForm.onsubmit = async (e) => {
                e.preventDefault();
                const profileData = {
                    salarioBruto: parseCurrency(document.getElementById('salario-bruto').value),
                    diaRecebimento: document.getElementById('dia-recebimento').value,
                };
                
                if (profileData.salarioBruto <= 0) {
                    showToast('Por favor, insira um salário válido.', 'error');
                    return;
                }

                try {
                    const userDocRef = doc(db, "users", user.uid);
                    await updateDoc(userDocRef, {
                        profile: profileData,
                        onboardingComplete: true
                    });
                    // onAuthStateChanged irá detetar a mudança e recarregar a app
                } catch (error) {
                    showToast('Erro ao salvar o perfil.', 'error');
                }
            };
        }

        // 7. LÓGICA DA APLICAÇÃO PRINCIPAL (DASHBOARD)
        function renderMainApp(user, userData) {
            appView.innerHTML = `
                <nav class="bg-carbon text-white w-64 p-4 space-y-4 hidden md:flex md:flex-col">
                    <h1 class="text-2xl font-bold text-center py-4">Fluxo <span class="text-accent-gold">CLT</span></h1>
                    <a href="#" class="nav-item active flex items-center p-3 rounded-lg">Dashboard</a>
                    <div class="mt-auto"><button id="logout-btn" class="w-full text-left nav-item flex items-center p-3 rounded-lg">Sair</button></div>
                </nav>
                <main class="flex-1 p-4 md:p-8 overflow-y-auto">
                    <div class="bg-carbon-light p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-4">Bem-vindo(a), ${userData.email}!</h2>
                        <p>Fase 1 completa! A base está pronta para construirmos os próximos módulos.</p>
                        <p class="mt-4">Salário Bruto: <strong>${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(userData.profile.salarioBruto || 0)}</strong></p>
                    </div>
                </main>
            `;

            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        }

    </script>
</body>
</html>
